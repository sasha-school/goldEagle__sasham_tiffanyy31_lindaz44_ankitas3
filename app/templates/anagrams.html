{% extends "base.html" %}

{% block title %}Friends{% endblock %}

{% block content %}
<style>
:root {
  --coyote: #7E6A4C;
  --timberwolf: #D9D3CA;
  --khaki: #C8B69A;
  --lion: #B08952;
  --coyote-2: #7E5927;
  --sepia: #653F0C;
  --caf-noir: #4B3A22;
  --black: #000200;
  --pakistan-green: #17310B;
  --dark-moss-green: #426011;
}

.anagram-container {
  max-width: 8800px;
  margin: 40px auto;
  background: var(--timberwolf);
  border-radius: 18px;
  box-shadow: 0 4px 4px rgba(126, 106, 76, 0.13);
  padding: 32px 36px 36px 36px;
  font-family: 'Segoe UI', Arial, sans-serif;
  border: 2px solid var(--coyote-2);
}

#tot {
  background: rgb(250, 248, 255);
  color: var(--black);
  border: none;
  border-radius: 8px;
  padding: 10px 28px;
  font-size: 1em;
  margin-bottom: 18px;
  box-shadow: 0 2px 8px rgba(176,137,82,0.13);
  font-weight: bold;
  letter-spacing: 1px;
}

#tot1 {
  background: rgb(250, 248, 255);
  color: var(--black);
  border: none;
  border-radius: 8px;
  padding: 10px 28px;
  font-size: 1em;
  margin-bottom: 18px;
  box-shadow: 0 2px 8px rgba(176,137,82,0.13);
  font-weight: bold;
  letter-spacing: 1px;
}


#plsStart1 {
  background: #444063;
  color: white;
  border: none;
  margin: 20px;
  border-radius: 8px;
  padding: 10px 28px;
  font-size: 1em;
  margin-top: 18px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: background 0.2s;
  font-weight: bold;
  letter-spacing: 1px;
  box-shadow: 0 2px 8px rgba(66,96,17,0.13);
}

#plsStart2 {
  background: #444063;
  color: white;
  border: none;
  margin: 20px;
  border-radius: 8px;
  padding: 10px 28px;
  font-size: 1em;
  margin-top: 18px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: background 0.2s;
  font-weight: bold;
  letter-spacing: 1px;
  box-shadow: 0 2px 8px rgba(66,96,17,0.13);
}

#enterWord {
  background: #9f9bbf;
  color: black;
  border: none;
  border-radius: 8px;
  padding: 10px 28px;
  font-size: 1.1em;
  margin-top: 18px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: background 0.2s;
  font-weight: bold;
  letter-spacing: 1px;
  box-shadow: 0 2px 8px rgba(66,96,17,0.13);
}
#enterWord:hover {
  background: #4e4a6bbc;
}
#timer {
  font-weight: 600;
  color: black;
}
#points {
  min-height: 24px;
  font-size: 1em;
  color: var(--lion);
  margin-bottom: 12px;
  font-weight: 600;
  text-align: center;
  animation-name: invisible;
  animation-duration: 2s;
}

#firstUser {
  background-color: var(--lion);
  margin:30px;
  display:block;
}


#secondUser {
  background-color: var(--lion);
  margin:30px;
  display:block;
}


@keyframes invisible {
  0% {
      opacity: 1;
      position:relative;
      top: -15px;

  }

  50% {
    opacity: 0.5;
    position:relative;
    top: -35px;

  }
  100% {
    opacity: 0;
    position:relative;
    top: -55px;

  }
}

#send_challenge_ana {
  display: block;
   vertical-align: middle;
   margin-left: -50px;
}
.seperate, .pls {
  display: flex;
  justify-content: center;
  gap: 18px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}

.box {
  width: 60px;
  height: 70px;
  background: rgb(206, 198, 234);
  border: 2px solid black;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: border 0.2s, box-shadow 0.2s, background 0.2s;
  box-shadow: 0 2px 8px rgba(126, 106, 76, 0.08);
  min-width: 70px;
  min-height: 70px;
}

.box:hover {
  background: var(--timberwolf);
  box-shadow: 0 4px 16px rgba(101,63,12,0.13);
}

#MyModal {
  background-color: rgb(255, 231, 169);
}
.letter {
  background: var(--timberwolf);
  box-shadow: 0px 5px 7px 4px rgba(0, 0, 0, 0.4);
  color: black;
  border-radius: 0%;
  width: 94px;
  height: 84px;
  font-size: 2em;
  font-weight: bold;
  cursor: grab;
  transition: background 0.2s, color 0.2s, border 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
 
  outline: none;
}

.letter:active {
  background: var(--lion);
  color: black;
  border: 2px solid var(--sepia);
}

.letter:focus {
  outline: 2px solid var(--coyote-2);
}

.anagram-container {
  background: linear-gradient(135deg, rgb(205, 201, 238) 80%, rgb(206, 202, 238) 100%);
}

@media (max-width: 600px) {
  .anagram-container {
    padding: 12px 4px;
  }
  .box {
    width: 40px;
    height: 40px;
    min-width: 48px;
    min-height: 48px;
  }
  .letter {
    width: 76px;
    height: 46px;
    font-size: 1.2em;
  }
}

#start-but {
  display: flex;
}


#both {
  display: flex;
}

#disp {
  display: block;
}

#img1, #img2, #img3, #img4, #img5, #img6 {

   opacity: 0;
   background-image: url("/static/img/wood.png");
   width: 90px;
}

</style>
<script>
  let challengeGame = false; //determine if score needs to be saved into challenge db too
  let receivedGame = false;

let time = 60;
let game = false;


/*
json structure:
user
scramble letters
dict of words with correspoending points
total points
*/

var words = [];
var pointsPerWord = [];


var dictWords = {};
for (let i = 0; i < words.length; i++) {
  dictWords[words[i]] = pointsPerWord[i];
}

var totPoint = 0;
var usedLetters = [];



function dragstartHandler(ev) {
  ev.dataTransfer.setData("text", ev.target.id);
}

function dragoverHandler(ev) {
  ev.preventDefault();
}

function dropHandler(ev) {
  ev.preventDefault();
  const data = ev.dataTransfer.getData("text");
  const imgTag = document.getElementById(data);

  const dropTarget = ev.target;
  const box = dropTarget.classList.contains("box") ? dropTarget : dropTarget.closest(".box");
  if (!box) return;
  if (box.querySelector("button")) {
    return;
  }
  box.appendChild(imgTag);
}

function clickMove(thing){
  let im = document.getElementById(thing);
  for (let i = 1; i < 7; i++) {

  if (!document.getElementById("div" + i).contains(document.getElementById("img1"))  && !document.getElementById("div" + i).contains(document.getElementById("img2")) && !document.getElementById("div" + i).contains(document.getElementById("img3")) && !document.getElementById("div" + i).contains(document.getElementById("img4")) && !document.getElementById("div" + i).contains(document.getElementById("img5")) && !document.getElementById("div" + i).contains(document.getElementById("img6"))) {
        document.getElementById("div" + i).appendChild(im);
        break;
  }
  }
 }

var boardStr = "";


function sendChallenge() {
  let scrm = "";
  for (let i = 1; i <= 6; i++) {
    scrm += document.getElementById('img' + i).textContent;
  }


  const inputVal = document.getElementById("friend_id");
  const friend_id = inputVal.value;

  const chNew = new FormData();
  chNew.append('ana_string', scrm);
  chNew.append('friend_id', friend_id);

  
  fetch('/send_anagrams_challenge', {
          method: 'POST',
          body: chNew
        })

  .then(response => response.json())
  
  .then(data => {
    if (data.redirect) {
            window.location.href = data.redirect;
            return;
    }
    else {
    startGame();
    challengeGame = true;
    }
    
  })
  .catch(error => console.error(error));
}


window.addEventListener('DOMContentLoaded', () => {
        const urlArgs = new URLSearchParams(window.location.search);
        if(urlArgs.has('board')){
          receivedGame = true;
          boardStr = urlArgs.get('board')
          for (let i = 0; i < 6; i++) {
        let el = document.getElementById("img" + (i+1))
        el.textContent = boardStr[i];
        }
          startGame();
        }
      })


function startGame() {
  game = true;
  for (let i = 1; i <= 6; i++) {
  let el = document.getElementById("img" + i)
  el.setAttribute('style', 'opacity:1;');
  }

  document.getElementById("friend_id").style.display="none";
  document.getElementById("send_challenge_ana").style.display="none";
  document.getElementById("plsStart2").style.display="none";


    document.getElementById("timer").textContent = time;
        let ID = window.setInterval(() => {
          if (time > 0){
            time = parseInt(time - 1);
            document.getElementById("timer").textContent = time;
          }
          else {
            clearInterval(ID);
            endGame();
          }
        }, 1000);


      }


  function saveBoard() {
  let scrm = "";
  for (let i = 1; i <= 6; i++) {
    scrm += document.getElementById('img' + i).textContent;
  }

  const wordData = new FormData();
  wordData.append('ana_string', scrm);
  fetch('/add_ana_string', {
    method: 'POST',
    body: wordData
  })
  .then(response => response.text())
  .then(data => {
    startGame();
    challengeGame = true;
  })
  .catch(error => console.error(error));
      
    }

function endGame() {
  let scrm = "";
  for (let i = 1; i <= 6; i++) {
    scrm += document.getElementById('img' + i).textContent;
  }
  document.getElementById("tot").textContent = totPoint;
  game=false;
  reset();
  scoreBoard();
 

  const result = new FormData();
  result.append('totPoint', totPoint)
  result.append('ana_string', scrm)


const single_score = fetch('/update_ana_score', {
  method: 'POST',
  body:result
}).then(response => response.text());

const A_score = challengeGame ? fetch('/update_ana_score_A', {
  method: 'POST',
  body:result
}).then(response => response.text()) : Promise.resolve(null);

const B_score = receivedGame ? fetch('/update_ana_score_B', {
  method: 'POST',
  body:result
}).then(response => response.text()) : Promise.resolve(null);


Promise.all([single_score, A_score, B_score])


.then(([data,data1,data2]) => {
   $("#myModal").modal();
    if (receivedGame) {
            window.location.href = '/ana_game'; //placeholder for end screen
          } else {
            location.reload();
            setTimeout(function() {
            location.reload();
          }, 5000);
          }
})
.catch(error => console.error(error));
       
      }



  function scoreBoard() {
    document.getElementById("tot").textContent = totPoint;
    for (let i = 0; i < words.length; i++) {
      let w = document.createElement('p');
      let p = document.createElement('p');
      w.textContent = words[i] + "      " + pointsPerWord[i].toString();
      document.getElementById("disp").appendChild(w);
      

    }
  }

  function reset() {
    for (let i = 0; i < 6; i++) {
      document.getElementById('img' + (i+1).toString()).innerHTML = "";
     document.getElementById('img' + (i+1).toString()).disabled = true;
     document.getElementById('div' + (i+1).toString()).disabled = true;
      document.getElementById('img' + (i+1).toString()).style.opacity = 0.5;


    }
    document.getElementById('enterWord').disabled = true;
  }




function checkLetters() {

   let scrm = "";
  for (let i = 1; i <= 6; i++) {
    scrm += document.getElementById('img' + i).textContent;
  }

  if (game==true) {
  const boxes = document.querySelectorAll(".seperate .box");
  const boxesAdd = document.querySelectorAll(".pls .addBoxy");
  let letters = "";
  let numLetters = 0;

  boxes.forEach(box => {
    const letterBtn = box.querySelector("button");
    if (letterBtn) {
      letters += letterBtn.textContent.trim();
      numLetters++;
    }
  });

  const msg = document.getElementById("points");
  const tot = document.getElementById("tot");
  const enter = document.getElementById("enterWord");
  let pointsCateg = { 3: 100, 4: 400, 5: 1200, 6: 2000 };

  let addLetters = [];

  if (numLetters >= 3) {
    fetch('https://ankita320.github.io/anagrams_wordList/wordList.json')
      .then(response => response.json())
      .then(data => {
        if (data.includes(letters.toLowerCase())) {
          if (usedLetters.includes(letters)) {
            msg.innerHTML = `&#9888; <b>${letters}</b> already used!`;
            emptyBoxes = [];
            for (let i = 0; i < 6; i++) {
              let addBack = document.querySelector(".pls .addBoxy" + i.toString());
              if (!addBack.querySelector("button")) {
                emptyBoxes.push(i);
              }
              }
            boxes.forEach((box, i) => {
            const button = box.querySelector("button");
            if (button) {
              box.removeChild(button);
              for (let i = 0; i < emptyBoxes.length; i++) {
                  let addBack = document.querySelector(".pls .addBoxy" + emptyBoxes[i].toString());
              if (!addBack.querySelector("button")) {
                addBack.appendChild(button);
              }
                }
            }
          });





          } else {
            usedLetters.push(letters);
            words.push(letters);
            let wL = words.length;
            let pointThing = pointsCateg[numLetters];
            pointsPerWord.push(pointThing);
            totPoint += pointThing;

            const wordData = new FormData();
            wordData.append('word', letters);
            wordData.append('ana_string', scrm);

            fetch('/add_ana_words', {
              method: 'POST',
              body: wordData
            })
            .then(response => response.text())
            .then(data => {
              console.log(data);
            })
            .catch(error => console.error(error));


            msg.innerHTML = `&#127942; <b>+${pointThing}</b> points!`;
            tot1.innerHTML = `WORDS: ${wL}`;
            tot.innerHTML = `SCORE: ${totPoint}`;
            emptyBoxes = [];
            for (let i = 0; i < 6; i++) {
              let addBack = document.querySelector(".pls .addBoxy" + i.toString());
              if (!addBack.querySelector("button")) {
                emptyBoxes.push(i);
              }
              }
            boxes.forEach((box, i) => {
            const button = box.querySelector("button");
            if (button) {
              box.removeChild(button);
              for (let i = 0; i < emptyBoxes.length; i++) {
                  let addBack = document.querySelector(".pls .addBoxy" + emptyBoxes[i].toString());
              if (!addBack.querySelector("button")) {
                addBack.appendChild(button);
              }
                }


            }
          });
          }


        } else {
          msg.innerHTML = `&#10060; <b>${letters}</b> not in vocabulary!`;
          emptyBoxes = [];
          for (let i = 0; i < 6; i++) {
            let addBack = document.querySelector(".pls .addBoxy" + i.toString());
            if (!addBack.querySelector("button")) {
              emptyBoxes.push(i);
            }
            }
          boxes.forEach((box, i) => {
            const button = box.querySelector("button");

            if (button) {
              box.removeChild(button);
              for (let i = 0; i < emptyBoxes.length; i++) {
                  let addBack = document.querySelector(".pls .addBoxy" + emptyBoxes[i].toString());
              if (!addBack.querySelector("button")) {
                addBack.appendChild(button);
              }
                }
            }
          });
        }
      })
      .catch(error => {
        msg.innerHTML = "Error checking word!";
      });
  } else {
    msg.innerHTML = "&#9888; Enter at least 3 letters!";
    enter.disabled = false;
  }
}}




</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">



<div class="anagram-container">
<div class="text-center">  <p id="timer" class="text-black text-3xl">60</p></div>
<div class="text-center" id="start-but">
<div id="send_challenge_ana">
    <input placeholder="User ID" id="friend_id" class="form-control w-auto d-inline-block"  type="number">
    <button id= "plsStart1" type="submit" onclick="sendChallenge()">Send Challenge: Start</button>
  </div>
<div><button id="plsStart2" onclick="saveBoard()">Single-Player Mode: Start</button></div>
</div>
  <br>
  <div class="text-center">
    <button id="tot1">WORDS: </button>
    <button id="tot">SCORE: </button>
  </div>
  <!--
  <div class="seperate">
    <div class="box" ondrop="dropHandler(event)" id="div1" ondragover="dragoverHandler(event)"></div>
    <div class="box" ondrop="dropHandler(event)" id="div2" ondragover="dragoverHandler(event)"></div>
    <div class="box" ondrop="dropHandler(event)" id="div3" ondragover="dragoverHandler(event)"></div>
    <div class="box" ondrop="dropHandler(event)" id="div4" ondragover="dragoverHandler(event)"></div>
    <div class="box" ondrop="dropHandler(event)" id="div5" ondragover="dragoverHandler(event)"></div>
     <div class="box" ondrop="dropHandler(event)" id="div6" ondragover="dragoverHandler(event)"></div>
  </div>

  <div class="text-center"><button id="enterWord" onclick="checkLetters()">Enter</button></div>

  <div id="points"></div>

  <div class="pls">
    {% if letters %}
    <div class="addBoxy0 box" id="div1" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)">
      <button class="letter" id="img1" draggable="true" ondragstart="dragstartHandler(event)">{{ letters.0 }}</button>
    </div>
    <div class="box addBoxy1" id="div2" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)">
      <button class="letter" id="img2" draggable="true" ondragstart="dragstartHandler(event)">{{ letters.1 }}</button>
    </div>
    <div class="box addBoxy2" id="div3" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)">
      <button class="letter" id="img3" draggable="true" ondragstart="dragstartHandler(event)">{{ letters.2 }}</button>
    </div>
    <div class="box addBoxy3" id="div4" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)">
      <button class="letter" id="img4" draggable="true" ondragstart="dragstartHandler(event)">{{ letters.3 }}</button>
    </div>
    <div class="box addBoxy4" id="div5" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)">
      <button class="letter" id="img5" draggable="true" ondragstart="dragstartHandler(event)">{{ letters.4 }}</button>
    </div>
  <div class="box addBoxy5" id="div6" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)">
      <button class="letter" id="img6" draggable="true" ondragstart="dragstartHandler(event)">{{ letters.5 }}</button>
    </div>
    {% endif %}
  </div>
</div>


    -->

      <div class="seperate">
    <div class="box" ondrop="dropHandler(event)" id="div1" ondragover="dragoverHandler(event)"></div>
    <div class="box" ondrop="dropHandler(event)" id="div2" ondragover="dragoverHandler(event)"></div>
    <div class="box" ondrop="dropHandler(event)" id="div3" ondragover="dragoverHandler(event)"></div>
    <div class="box" ondrop="dropHandler(event)" id="div4" ondragover="dragoverHandler(event)"></div>
    <div class="box" ondrop="dropHandler(event)" id="div5" ondragover="dragoverHandler(event)"></div>
     <div class="box" ondrop="dropHandler(event)" id="div6" ondragover="dragoverHandler(event)"></div>
  </div>

  <div class="text-center"><button id="enterWord" onclick="checkLetters()">Enter</button></div>

  <div id="points"></div>

  <div class="pls">
    {% if letters %}
    <div class="addBoxy0 box" id="div1" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)">
      <button width="87px" class="letter text-transparent" id="img1" onclick="clickMove('img1') " draggable="true" ondragstart="dragstartHandler(event)">{{ letters.0 }}</button>
    </div>
    <div class="box addBoxy1" id="div2" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)">
      <button class="letter" id="img2" onclick="clickMove('img2')" draggable="true" ondragstart="dragstartHandler(event)">{{ letters.1 }}</button>
    </div>
    <div class="box addBoxy2" id="div3" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)">
      <button class="letter" id="img3" onclick="clickMove('img3')" draggable="true" ondragstart="dragstartHandler(event)">{{ letters.2 }}</button>
    </div>
    <div class="box addBoxy3" id="div4" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)">
      <button class="letter" id="img4" onclick="clickMove('img4')" draggable="true" ondragstart="dragstartHandler(event)">{{ letters.3 }}</button>
    </div>
    <div class="box addBoxy4" id="div5" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)">
      <button class="letter" id="img5" onclick="clickMove('img5')" draggable="true" ondragstart="dragstartHandler(event)">{{ letters.4 }}</button>
    </div>
  <div class="box addBoxy5" id="div6" ondrop="dropHandler(event)" ondragover="dragoverHandler(event)">
      <button class="letter" id="img6" onclick="clickMove('img6')" draggable="true" ondragstart="dragstartHandler(event)">{{ letters.5 }}</button>
    </div>
    {% endif %}
  </div>

<!-- Modal -->
 <div id= "myModal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="staticBackdropLabel">Score Board</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
     
    <div id="both">
      <div id="firstUser">
      <h3>{{ userName }}</h3>
       <button id="tot">SCORE: </button>
      <div class="modal-body" id="disp">
        <p></p> <p></p> <br>
      </div>
      </div>



        <div id="secondUser">
      <h3>{{ userName }}</h3>
      <div class="modal-body" id="disp">
        <p></p> <p></p> <br>
      </div>
      </div>
       </div>

    </div>
  </div>
</div>


  </div>
</div>
{% endblock %}</div>
